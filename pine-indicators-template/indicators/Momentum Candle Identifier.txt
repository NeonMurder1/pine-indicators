// @version=6
indicator("Momentum Candle Identifier ", overlay=true)

// User-defined inputs
lookbackPeriod = input.int(5, title="Lookback Period", minval=2, maxval=50, tooltip="Number of previous candles to compare with")
thresholdMultiplier = input.float(1.5, title="Size Threshold Multiplier", minval=1.0, maxval=5.0, step=0.1, tooltip="Multiplier to determine what qualifies as a momentum candle")
bullishMomentumColor = input.color(color.rgb(0, 255, 0), title="Bullish Momentum Candle Color")
bearishMomentumColor = input.color(color.rgb(255, 0, 0), title="Bearish Momentum Candle Color")
showLabels = input.bool(false, title="Show Momentum Labels")

// Calculate candle body size (difference between open and close)
candleSize = math.abs(close - open)

// Calculate the average candle size over the lookback period
avgCandleSize = ta.sma(candleSize, lookbackPeriod)

// Identify momentum candles
isMomentumCandle = candleSize > avgCandleSize * thresholdMultiplier
isBullishMomentum = isMomentumCandle and close > open
isBearishMomentum = isMomentumCandle and close < open

// Color the momentum candles
barcolor(isMomentumCandle ? (close > open ? bullishMomentumColor : bearishMomentumColor) : na)

// Add label to momentum candles if enabled
if showLabels and isMomentumCandle
    label.new(bar_index, high, text="Momentum\nCandle", style=label.style_label_down, 
              color=close > open ? bullishMomentumColor : bearishMomentumColor, 
              textcolor=color.white, size=size.small, 
              tooltip="Body size: " + str.tostring(candleSize, "#.##"))

// Plot the average candle size for reference
plot(avgCandleSize, title="Average Candle Size", color=color.blue, style=plot.style_line, linewidth=1)

// Display information in a table
var table infoTable = table.new(position.top_right, 2, 4, color.black, color.white, 1, color.gray, 1)
if barstate.islastconfirmedhistory
    table.cell(infoTable, 0, 0, "Lookback Period", text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 1, 0, str.tostring(lookbackPeriod), text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 0, 1, "Avg Body Size", text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 1, 1, str.tostring(avgCandleSize, "#.##"), text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 0, 2, "Threshold", text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 1, 2, str.tostring(avgCandleSize * thresholdMultiplier, "#.##"), text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    table.cell(infoTable, 0, 3, "Momentum Candles", text_color=color.white, bgcolor=color.rgb(38, 38, 38))
    momentumCount = math.sum(isMomentumCandle ? 1 : 0, lookbackPeriod * 5)
    table.cell(infoTable, 1, 3, str.tostring(momentumCount), text_color=color.white, bgcolor=color.rgb(38, 38, 38))