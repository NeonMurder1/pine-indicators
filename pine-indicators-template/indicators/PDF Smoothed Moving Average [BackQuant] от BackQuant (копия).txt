// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© BackQuant

//@version=6
indicator(
 "PDF Smoothed Moving Average [BackQuant]", 
 shorttitle = "PDF-MA [BackQuant]",
 overlay=true
 )

// define user inputs
const string userI = "User Inputs"

series float  src = input.source(close, "Price Source", group=userI)
string        smoothingMethod = input.string("EMA", "Smoothing Method", options=["EMA", "SMA"], group=userI)
simple int    period = input.int(20, "Smoothing Period", minval=1, group=userI)
simple float  variance = input.float(1.5, "PDF Variance", step=0.1, minval=0.1, group=userI)
simple float  mean = input.float(0.0, "PDF Mean", step=0.1, minval=-1.0, maxval=1.0, group=userI)

simple bool   showpdf = input.bool(true, "Show PDF MA on chart?", group = "UI Settings")
simple bool   paintCandles = input.bool(true, "Paint candles according to Trend?", group = "UI Settings")

// PDF Function
pdf(x, variance, mean) =>
    1 / (variance * math.sqrt(2 * math.pi)) * math.exp(-math.pow(x - mean, 2) / (2 * math.pow(variance, 2)))

// MA Function
pdf_ma(src, period, variance, mean, method) =>
    step = math.pi / (period - 1)
    coeffs = array.new_float()
    for k = 0 to period - 1
        x = k * step
        weight = pdf(x, variance, mean * math.pi)
        array.push(coeffs, weight)
    sum_weights = array.sum(coeffs)
    weighted_sum = 0.0
    for i = 0 to period - 1
        weight = array.get(coeffs, i)
        src_value = nz(src[i])
        weighted_sum += weight * src_value
    weighted_avg = weighted_sum / sum_weights

    ma = method == "EMA" ? ta.ema(src, period) : ta.sma(src, period)
    out = (weighted_avg + ma) / 2
    out

pdf_ma_val = pdf_ma(src, period, variance, mean, smoothingMethod)


// Conditional Trend
var Trend = 0

if pdf_ma_val>pdf_ma_val[1]
    Trend := 1
if pdf_ma_val<pdf_ma_val[1] 
    Trend := -1

// Colouring
var barColour = #ffffff
if Trend == 1 
    barColour := #33ff00
if Trend == -1
    barColour := #ff0000

// Plotting
barcolor(paintCandles ? barColour : na)

plot(
 showpdf ? pdf_ma_val : na, 
 "PDF MA", 
 color = color.new(barColour, 40), 
 linewidth = 4
 )



