//@version=5
indicator("Volume Bulls vs Bears (Improved)", shorttitle="VolBullsBears", overlay=false)

// User-defined inputs
volAvgPeriod = input.int(20, title="Volume SMA Period", minval=1)
bullColor = input.color(color.new(color.green, 0), title="Bull Color")
bearColor = input.color(color.new(color.red, 0), title="Bear Color")
volAvgColor = input.color(color.new(color.yellow, 0), title="Volume SMA Color")
lineWidth = input.int(2, title="SMA Line Width", minval=1)

// Calculate bulls and bears volume
totalVolume = volume
priceRange = high - low > 0 ? high - low : na  // Prevent division by zero
bulls = (close - low) / priceRange * totalVolume
bears = (high - close) / priceRange * totalVolume

// Calculate SMA of volume
volSMA = ta.sma(totalVolume, volAvgPeriod)

// Plot stacked histogram
hBull = plot(bulls, title="Bulls", style=plot.style_columns, color=bullColor, linewidth=0)
hBear = plot(bears, title="Bears", style=plot.style_columns, color=bearColor, linewidth=0)

// Fill between bulls and bears
fill(hBull, hBear, color=na) // Prevent overlap, visually stacked

// Plot SMA line
plot(volSMA, title="Volume SMA", color=volAvgColor, linewidth=lineWidth)
